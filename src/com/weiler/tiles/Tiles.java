package com.weiler.tiles;

import static com.codename1.ui.CN.*;

import com.codename1.io.*;
import com.codename1.social.LoginCallback;
import com.codename1.ui.*;
import com.codename1.ui.layouts.BorderLayout;
import com.codename1.ui.plaf.UIManager;
import com.codename1.ui.util.Resources;
import java.io.IOException;
import java.util.Map;
import java.io.InputStream;
import java.io.InputStreamReader;
import com.codename1.ui.layouts.GridLayout;
import com.codename1.social.GoogleConnect;
import com.codename1.ui.plaf.Style;
import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;



import com.codename1.social.Login;


/**
 * This file was generated by <a href="https://www.codenameone.com/">Codename One</a> for the purpose 
 * of building native mobile applications using Java.
 */
public class Tiles {

    private Form current;
    private Resources theme;
    private static String tokenPrefix="google";
    private Image milton;
    private String fullName;
    private String uniqueId;
    private String imageURL;
    private addEventForm form1 = new addEventForm();
    private Form createEvent;
    private DataBaseHelper globalBase = new DataBaseHelper();
    public Cloudinary cloudinary;


    public void init(Object context) {
        theme = UIManager.initFirstTheme("/theme");

        // Enable Toolbar on all Forms by default
        Toolbar.setGlobalToolbar(true);

        // Pro only feature
        Log.bindCrashProtection(true);

        //INITIALIZATION
        fullName = Preferences.get("fullName", null);
        uniqueId = Preferences.get("uniqueId", null);
        imageURL = Preferences.get("imageURL", null);

        //CLOUDINARY INIT
        cloudinary = new Cloudinary(ObjectUtils.asMap(
                "cloud_name", "tiles",
                "api_key", "817285289173163",
                "api_secret", "H9YMuHi-ZYdtLAMfyXpfbQFZ4OI"));

        // Disable private CDN URLs as this doesn't seem to work with free accounts
        cloudinary.config.privateCdn = false;



    }
    
    public void start() {
        if (current != null) {
            current.show();
            return;
        }
        Form hi = new Form("Welcome", new BorderLayout(BorderLayout.CENTER_BEHAVIOR_CENTER_ABSOLUTE));

        //showLoginForm();
        System.out.println(globalBase.getPosts("milton_academy"));
        TileForm tileFormTool = new TileForm();
        addEventForm evtFormTool = new addEventForm();
        evtFormTool.imageCreation().show();
        //tileFormTool.formCreated().show();
    }

    private void showLoginForm() {
        Form loginForm = new Form("Log In", new BorderLayout((BorderLayout.CENTER_BEHAVIOR_CENTER_ABSOLUTE)));

        Container panela = new Container();
        Container panelb = new Container();
        Container panelbb = new Container();

        try {
            milton= Image.createImage("/Homepage.jpg");
        } catch (IOException e1) {
            e1.printStackTrace();
        }

        Label img = new Label("PIC");


        Button loginWithGoogle = new Button("Signin with Google");
        loginWithGoogle.addActionListener((e) -> {
            tokenPrefix = "google";
            Login gc = GoogleConnect.getInstance();
            gc.setClientId("1063668062883-etbppkvqrepcavge8043lpqhhm1bs4bi.apps.googleusercontent.com\n");
            gc.setRedirectURI("http://www.codenameone.com/oauth2callback");
            gc.setClientSecret("iq6W5bQ8K6gYmpLwlNyutwuF\n");
            gc.setCallback(new LoginCallback() {
                public void loginSuccessful() {
                    createEvent.show();
                }

                public void loginFailed(String errorMessage) {System.out.println(errorMessage);}
            });
            if(!gc.isUserLoggedIn()){
                gc.doLogin();
            }else{
                String token = gc.getAccessToken().getToken();
                createEvent.show();
            }
            doLogin(gc, new GoogleData(), false);
        });

        panela.setLayout(new GridLayout(1,1));
        panela.add(img);

        panelbb.setLayout(new GridLayout(1,1));
        panelbb.add(loginWithGoogle);

        panelb.setLayout(new GridLayout(1,1));
        panelb.add(panelbb);

        loginForm.setLayout(new GridLayout(2,1));

        loginForm.addComponent(panela);
        loginForm.addComponent(panelb);
        loginForm.show();
    }

    void doLogin(Login lg, UserData data, boolean forceLogin) {
        if(!forceLogin) {
            if(lg.isUserLoggedIn()) {
                System.out.println("LOGIN SUCESSFUL");
                return;
            }

            // if the user already logged in previously and we have a token
            String t = Preferences.get(tokenPrefix + "token", (String)null);
            if(t != null) {
                // we check the expiration of the token which we previously stored as System time
                long tokenExpires = Preferences.get(tokenPrefix + "tokenExpires", (long)-1);
                if(tokenExpires < 0 || tokenExpires > System.currentTimeMillis()) {
                    // we are still logged in
                    System.out.println("We are still logged in");
                    createEvent.show();
                    return;
                }
            }
        }
        lg.setCallback(new LoginCallback() {
            @Override
            public void loginFailed(String errorMessage) {
                Dialog.show("Error Logging In", "There was an error logging in: " + errorMessage, "OK", null);
            }

            @Override
            public void loginSuccessful() {
                // when login is successful we fetch the full data
                data.fetchData(lg.getAccessToken().getToken(), ()-> {
                    // we store the values of result into local variables
                    uniqueId = data.getId();
                    fullName = data.getName();
                    imageURL = data.getImage();

                    // we then store the data into local cached storage so they will be around when we run the app next time
                    Preferences.set("fullName", fullName);
                    Preferences.set("uniqueId", uniqueId);
                    Preferences.set("imageURL", imageURL);
                    Preferences.set(tokenPrefix + "token", lg.getAccessToken().getToken());

                    // token expiration is in seconds from the current time, we convert it to a System.currentTimeMillis value so we can
                    // reference it in the future to check expiration
                    Preferences.set(tokenPrefix + "tokenExpires", tokenExpirationInMillis(lg.getAccessToken()));
                    System.out.println("wassup");
                    createEvent.show();
                });
            }
        });
        lg.doLogin();
    }



    public void stop() {
        current = getCurrentForm();
        if(current instanceof Dialog) {
            ((Dialog)current).dispose();
            current = getCurrentForm();
        }
    }
    
    public void destroy() {
    }



    //Create Login situtation
    long tokenExpirationInMillis(AccessToken token) {
        String expires = token.getExpires();
        if(expires != null && expires.length() > 0) {
            try {
                // when it will expire in seconds
                long l = (long)(Float.parseFloat(expires) * 1000);
                return System.currentTimeMillis() + l;
            } catch(NumberFormatException err) {
                // ignore invalid input
            }
        }
        return -1;
    }

    static interface UserData {
        public String getName();
        public String getId();
        public String getImage();
        public void fetchData(String token, Runnable callback);
    }

    class GoogleData extends ConnectionRequest implements UserData {
        private Runnable callback;
        private Map<String, Object> parsedData;

        @Override
        public String getName() {
            return (String) parsedData.get("displayName");
        }

        @Override
        public String getId() {
            return parsedData.get("id").toString();
        }

        @Override
        public String getImage() {
            Map<String, Object> imageMeta = ((Map<String, Object>) parsedData.get("image"));
            return (String) imageMeta.get("url");
        }

        @Override
        public void fetchData(String token, Runnable callback) {
            this.callback = callback;
            addRequestHeader("Authorization", "Bearer " + token);
            setUrl("https://www.googleapis.com/plus/v1/people/me");
            setPost(false);
            NetworkManager.getInstance().addToQueue(this);
        }

        @Override
        protected void handleErrorResponseCode(int code, String message) {
            //access token not valid anymore
            if (code >= 400 && code <= 410) {
                doLogin(GoogleConnect.getInstance(), this, true);
                System.out.println("ERRORRRRRR");
                return;
            }
            super.handleErrorResponseCode(code, message);
            System.out.println("ERRORRRRR");
        }


        @Override
        protected void readResponse(InputStream input) throws IOException {
            JSONParser parser = new JSONParser();
            parsedData = parser.parseJSON(new InputStreamReader(input, "UTF-8"));
        }

        @Override
        protected void postResponse() {
            callback.run();
        }

        private String token;

    }

}
